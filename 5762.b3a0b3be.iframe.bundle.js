"use strict";(self.webpackChunk_woocommerce_storybook=self.webpackChunk_woocommerce_storybook||[]).push([[5762],{"../../node_modules/.pnpm/@wordpress+media-utils@3.4.1/node_modules/@wordpress/media-utils/build-module/index.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Q:()=>media_upload,o:()=>uploadMedia});var lodash=__webpack_require__("../../node_modules/.pnpm/lodash@4.17.21/node_modules/lodash/lodash.js"),react=__webpack_require__("../../node_modules/.pnpm/react@18.3.1/node_modules/react/index.js"),build_module=__webpack_require__("../../node_modules/.pnpm/@wordpress+i18n@4.6.1/node_modules/@wordpress/i18n/build-module/index.js");const{wp}=window,DEFAULT_EMPTY_GALLERY=[],getFeaturedImageMediaFrame=()=>wp.media.view.MediaFrame.Select.extend({featuredImageToolbar(toolbar){this.createSelectToolbar(toolbar,{text:wp.media.view.l10n.setFeaturedImage,state:this.options.state})},editState(){const selection=this.state("featured-image").get("selection"),view=new wp.media.view.EditImage({model:selection.single(),controller:this}).render();this.content.set(view),view.loadEditor()},createStates:function createStates(){this.on("toolbar:create:featured-image",this.featuredImageToolbar,this),this.on("content:render:edit-image",this.editState,this),this.states.add([new wp.media.controller.FeaturedImage,new wp.media.controller.EditImage({model:this.options.editImage})])}}),getGalleryDetailsMediaFrame=()=>wp.media.view.MediaFrame.Post.extend({galleryToolbar(){const editing=this.state().get("editing");this.toolbar.set(new wp.media.view.Toolbar({controller:this,items:{insert:{style:"primary",text:editing?wp.media.view.l10n.updateGallery:wp.media.view.l10n.insertGallery,priority:80,requires:{library:!0},click(){const controller=this.controller,state=controller.state();controller.close(),state.trigger("update",state.get("library")),controller.setState(controller.options.state),controller.reset()}}}}))},editState(){const selection=this.state("gallery").get("selection"),view=new wp.media.view.EditImage({model:selection.single(),controller:this}).render();this.content.set(view),view.loadEditor()},createStates:function createStates(){this.on("toolbar:create:main-gallery",this.galleryToolbar,this),this.on("content:render:edit-image",this.editState,this),this.states.add([new wp.media.controller.Library({id:"gallery",title:wp.media.view.l10n.createGalleryTitle,priority:40,toolbar:"main-gallery",filterable:"uploaded",multiple:"add",editable:!1,library:wp.media.query((0,lodash.defaults)({type:"image"},this.options.library))}),new wp.media.controller.EditImage({model:this.options.editImage}),new wp.media.controller.GalleryEdit({library:this.options.selection,editing:this.options.editing,menu:"gallery",displaySettings:!1,multiple:!0}),new wp.media.controller.GalleryAdd])}}),slimImageObject=img=>(0,lodash.pick)(img,["sizes","mime","type","subtype","id","url","alt","link","caption"]),getAttachmentsCollection=ids=>wp.media.query({order:"ASC",orderby:"post__in",post__in:ids,posts_per_page:-1,query:!0,type:"image"});class MediaUpload extends react.Component{constructor(_ref){let{allowedTypes,gallery=!1,unstableFeaturedImageFlow=!1,modalClass,multiple=!1,title=(0,build_module.__)("Select or Upload Media")}=_ref;if(super(...arguments),this.openModal=this.openModal.bind(this),this.onOpen=this.onOpen.bind(this),this.onSelect=this.onSelect.bind(this),this.onUpdate=this.onUpdate.bind(this),this.onClose=this.onClose.bind(this),gallery)this.buildAndSetGalleryFrame();else{const frameConfig={title,multiple};allowedTypes&&(frameConfig.library={type:allowedTypes}),this.frame=wp.media(frameConfig)}modalClass&&this.frame.$el.addClass(modalClass),unstableFeaturedImageFlow&&this.buildAndSetFeatureImageFrame(),this.initializeListeners()}initializeListeners(){this.frame.on("select",this.onSelect),this.frame.on("update",this.onUpdate),this.frame.on("open",this.onOpen),this.frame.on("close",this.onClose)}buildAndSetGalleryFrame(){const{addToGallery=!1,allowedTypes,multiple=!1,value=DEFAULT_EMPTY_GALLERY}=this.props;if(value===this.lastGalleryValue)return;let currentState;this.lastGalleryValue=value,this.frame&&this.frame.remove(),currentState=addToGallery?"gallery-library":value&&value.length?"gallery-edit":"gallery",this.GalleryDetailsMediaFrame||(this.GalleryDetailsMediaFrame=getGalleryDetailsMediaFrame());const attachments=getAttachmentsCollection(value),selection=new wp.media.model.Selection(attachments.models,{props:attachments.props.toJSON(),multiple});this.frame=new this.GalleryDetailsMediaFrame({mimeType:allowedTypes,state:currentState,multiple,selection,editing:!(!value||!value.length)}),wp.media.frame=this.frame,this.initializeListeners()}buildAndSetFeatureImageFrame(){const featuredImageFrame=getFeaturedImageMediaFrame(),attachments=getAttachmentsCollection(this.props.value),selection=new wp.media.model.Selection(attachments.models,{props:attachments.props.toJSON()});this.frame=new featuredImageFrame({mimeType:this.props.allowedTypes,state:"featured-image",multiple:this.props.multiple,selection,editing:!!this.props.value}),wp.media.frame=this.frame}componentWillUnmount(){this.frame.remove()}onUpdate(selections){const{onSelect,multiple=!1}=this.props,state=this.frame.state(),selectedImages=selections||state.get("selection");selectedImages&&selectedImages.models.length&&onSelect(multiple?selectedImages.models.map((model=>slimImageObject(model.toJSON()))):slimImageObject(selectedImages.models[0].toJSON()))}onSelect(){const{onSelect,multiple=!1}=this.props,attachment=this.frame.state().get("selection").toJSON();onSelect(multiple?attachment:attachment[0])}onOpen(){var _this$props$value;this.updateCollection();if(!(Array.isArray(this.props.value)?!(null===(_this$props$value=this.props.value)||void 0===_this$props$value||!_this$props$value.length):!!this.props.value))return;const isGallery=this.props.gallery,selection=this.frame.state().get("selection");isGallery||(0,lodash.castArray)(this.props.value).forEach((id=>{selection.add(wp.media.attachment(id))}));const attachments=getAttachmentsCollection((0,lodash.castArray)(this.props.value));attachments.more().done((function(){var _attachments$models;isGallery&&null!=attachments&&null!==(_attachments$models=attachments.models)&&void 0!==_attachments$models&&_attachments$models.length&&selection.add(attachments.models)}))}onClose(){const{onClose}=this.props;onClose&&onClose()}updateCollection(){const frameContent=this.frame.content.get();if(frameContent&&frameContent.collection){const collection=frameContent.collection;collection.toArray().forEach((model=>model.trigger("destroy",model))),collection.mirroring._hasMore=!0,collection.more()}}openModal(){this.props.gallery&&this.buildAndSetGalleryFrame(),this.frame.open()}render(){return this.props.render({open:this.openModal})}}const media_upload=MediaUpload;var api_fetch_build_module=__webpack_require__("../../node_modules/.pnpm/@wordpress+api-fetch@6.3.1/node_modules/@wordpress/api-fetch/build-module/index.js");const{createObjectURL,revokeObjectURL}=window.URL,cache={};function createBlobURL(file){const url=createObjectURL(file);return cache[url]=file,url}async function uploadMedia(_ref){let{allowedTypes,additionalData={},filesList,maxUploadFileSize,onError=lodash.noop,onFileChange,wpAllowedMimeTypes=null}=_ref;const files=[...filesList],filesSet=[],setAndUpdateFiles=(idx,value)=>{!function revokeBlobURL(url){cache[url]&&revokeObjectURL(url),delete cache[url]}((0,lodash.get)(filesSet,[idx,"url"])),filesSet[idx]=value,onFileChange((0,lodash.compact)(filesSet))},isAllowedType=fileType=>!allowedTypes||(0,lodash.some)(allowedTypes,(allowedType=>(0,lodash.includes)(allowedType,"/")?allowedType===fileType:(0,lodash.startsWith)(fileType,`${allowedType}/`))),allowedMimeTypesForUser=function getMimeTypesArray(wpMimeTypesObject){return wpMimeTypesObject?(0,lodash.flatMap)(wpMimeTypesObject,((mime,extensionsString)=>{const[type]=mime.split("/"),extensions=extensionsString.split("|");return[mime,...(0,lodash.map)(extensions,(extension=>`${type}/${extension}`))]})):wpMimeTypesObject}(wpAllowedMimeTypes),triggerError=error=>{error.message=[(0,react.createElement)("strong",{key:"filename"},error.file.name),": ",error.message],onError(error)},validFiles=[];for(const mediaFile of files)allowedMimeTypesForUser&&mediaFile.type&&(fileType=mediaFile.type,!(0,lodash.includes)(allowedMimeTypesForUser,fileType))?triggerError({code:"MIME_TYPE_NOT_ALLOWED_FOR_USER",message:(0,build_module.__)("Sorry, you are not allowed to upload this file type."),file:mediaFile}):!mediaFile.type||isAllowedType(mediaFile.type)?maxUploadFileSize&&mediaFile.size>maxUploadFileSize?triggerError({code:"SIZE_ABOVE_LIMIT",message:(0,build_module.__)("This file exceeds the maximum upload size for this site."),file:mediaFile}):mediaFile.size<=0?triggerError({code:"EMPTY_FILE",message:(0,build_module.__)("This file is empty."),file:mediaFile}):(validFiles.push(mediaFile),filesSet.push({url:createBlobURL(mediaFile)}),onFileChange(filesSet)):triggerError({code:"MIME_TYPE_NOT_SUPPORTED",message:(0,build_module.__)("Sorry, this file type is not supported here."),file:mediaFile});var fileType;for(let idx=0;idx<validFiles.length;++idx){const mediaFile=validFiles[idx];try{const savedMedia=await createMediaFromFile(mediaFile,additionalData);setAndUpdateFiles(idx,{...(0,lodash.omit)(savedMedia,["alt_text","source_url"]),alt:savedMedia.alt_text,caption:(0,lodash.get)(savedMedia,["caption","raw"],""),title:savedMedia.title.raw,url:savedMedia.source_url})}catch(error){let message;setAndUpdateFiles(idx,null),message=(0,lodash.has)(error,["message"])?(0,lodash.get)(error,["message"]):(0,build_module.nv)((0,build_module.__)("Error while uploading file %s to the media library."),mediaFile.name),onError({code:"GENERAL",message,file:mediaFile})}}}function createMediaFromFile(file,additionalData){const data=new window.FormData;return data.append("file",file,file.name||file.type.replace("/",".")),(0,lodash.forEach)(additionalData,((value,key)=>data.append(key,value))),(0,api_fetch_build_module.A)({path:"/wp/v2/media",body:data,method:"POST"})}}}]);