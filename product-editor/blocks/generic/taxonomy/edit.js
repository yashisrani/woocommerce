"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Edit=void 0;const element_1=require("@wordpress/element");require("@woocommerce/settings");const block_templates_1=require("@woocommerce/block-templates"),components_1=require("@woocommerce/components"),compose_1=require("@wordpress/compose"),data_1=require("@wordpress/data"),create_taxonomy_modal_1=require("./create-taxonomy-modal"),use_taxonomy_search_1=__importDefault(require("./use-taxonomy-search")),use_product_entity_prop_1=__importDefault(require("../../../hooks/use-product-entity-prop")),label_1=require("../../../components/label/label");function Edit({attributes,context:{postType,isInSelectedTab}}){const blockProps=(0,block_templates_1.useWooBlockProps)(attributes),{hierarchical}=(0,data_1.useSelect)((select=>select("core").getTaxonomy(attributes.slug)||{hierarchical:!1})),{label,help,slug,property,createTitle,dialogNameHelpText,parentTaxonomyText,disabled,placeholder}=attributes,[searchValue,setSearchValue]=(0,element_1.useState)(""),[allEntries,setAllEntries]=(0,element_1.useState)([]),{searchEntity,isResolving}=(0,use_taxonomy_search_1.default)(slug,{fetchParents:hierarchical}),searchDelayed=(0,compose_1.useDebounce)((0,element_1.useCallback)((val=>{setSearchValue(val),searchEntity(val||"").then(setAllEntries)}),[hierarchical]),150);(0,element_1.useEffect)((()=>{isInSelectedTab&&searchDelayed("")}),[isInSelectedTab]);const[selectedEntries,setSelectedEntries]=(0,use_product_entity_prop_1.default)(property,{postType,fallbackValue:[]}),mappedEntries=(selectedEntries||[]).map((b=>({value:String(b.id),label:b.name}))),[showCreateNewModal,setShowCreateNewModal]=(0,element_1.useState)(!1),mappedAllEntries=allEntries.map((taxonomy=>({parent:hierarchical&&taxonomy.parent&&taxonomy.parent>0?String(taxonomy.parent):void 0,label:taxonomy.name,value:String(taxonomy.id)})));return(0,element_1.createElement)("div",{...blockProps},(0,element_1.createElement)(element_1.Fragment,null,(0,element_1.createElement)(components_1.__experimentalSelectTreeControl,{id:(0,compose_1.useInstanceId)(components_1.__experimentalSelectTreeControl,"woocommerce-taxonomy-select"),label:(0,element_1.createElement)(label_1.Label,{label,tooltip:help}),isLoading:isResolving,disabled,multiple:!0,createValue:searchValue,onInputChange:searchDelayed,placeholder,shouldNotRecursivelySelect:!0,shouldShowCreateButton:typedValue=>!typedValue||-1===mappedAllEntries.findIndex((taxonomy=>taxonomy.label.toLowerCase()===typedValue.toLowerCase())),onCreateNew:()=>setShowCreateNewModal(!0),items:mappedAllEntries,selected:mappedEntries,onSelect:selectedItems=>{Array.isArray(selectedItems)?setSelectedEntries([...selectedItems.map((i=>({id:+i.value,name:i.label,parent:+(i.parent||0)}))),...selectedEntries||[]]):setSelectedEntries([{id:+selectedItems.value,name:selectedItems.label,parent:+(selectedItems.parent||0)},...selectedEntries||[]])},onRemove:removedItems=>{Array.isArray(removedItems)?setSelectedEntries((selectedEntries||[]).filter((taxonomy=>!removedItems.find((item=>item.value===String(taxonomy.id)))))):setSelectedEntries((selectedEntries||[]).filter((taxonomy=>String(taxonomy.id)!==removedItems.value)))},onClear:function handleClear(){setSelectedEntries([])},isClearingAllowed:(selectedEntries||[]).length>0}),showCreateNewModal&&(0,element_1.createElement)(create_taxonomy_modal_1.CreateTaxonomyModal,{slug,hierarchical,title:createTitle,dialogNameHelpText,parentTaxonomyText,onCancel:()=>setShowCreateNewModal(!1),onCreate:taxonomy=>{setShowCreateNewModal(!1),setSearchValue(""),setSelectedEntries([{id:taxonomy.id,name:taxonomy.name,parent:taxonomy.parent},...selectedEntries||[]])},initialName:searchValue})))}exports.Edit=Edit;