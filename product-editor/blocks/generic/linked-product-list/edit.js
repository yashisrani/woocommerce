"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LinkedProductListBlockEdit=exports.EmptyStateImage=void 0;const element_1=require("@wordpress/element"),block_templates_1=require("@woocommerce/block-templates"),data_1=require("@wordpress/data"),data_2=require("@woocommerce/data"),components_1=require("@wordpress/components"),i18n_1=require("@wordpress/i18n"),icons_1=require("@wordpress/icons"),tracks_1=require("@woocommerce/tracks"),compose_1=require("@wordpress/compose"),core_data_1=require("@wordpress/core-data"),use_product_entity_prop_1=__importDefault(require("../../../hooks/use-product-entity-prop")),product_list_1=require("../../../components/product-list"),product_select_1=require("../../../components/product-select"),advice_card_1=require("../../../components/advice-card"),constants_1=require("../../../constants"),shopping_bags_1=require("../../../images/shopping-bags"),cash_register_1=require("../../../images/cash-register"),reducer_1=require("./reducer"),get_related_products_1=require("../../../utils/get-related-products"),block_slot_fill_1=require("../../../components/block-slot-fill");function EmptyStateImage({image,tip:description}){switch(image){case"CashRegister":return(0,element_1.createElement)(cash_register_1.CashRegister,null);case"ShoppingBags":return(0,element_1.createElement)(shopping_bags_1.ShoppingBags,null);default:return/^https?:\/\//.test(image)?(0,element_1.createElement)("img",{src:image,alt:description,height:88,width:88}):null}}async function getProductsBySearchValue(searchValue="",excludedIds=[]){return(0,data_1.resolveSelect)(data_2.PRODUCTS_STORE_NAME).getProducts({search:searchValue,orderby:"title",order:"asc",per_page:5,exclude:excludedIds})}function LinkedProductListBlockEdit({attributes,context:{postType,isInSelectedTab}}){const{property,emptyState}=attributes,loadInitialSearchResults=(0,element_1.useRef)(!1),[,setSearchValue]=(0,element_1.useState)(""),[searchedProducts,setSearchedProducts]=(0,element_1.useState)([]),[isSearching,setIsSearching]=(0,element_1.useState)(!1),blockProps=(0,block_templates_1.useWooBlockProps)(attributes),[state,dispatch]=(0,element_1.useReducer)(reducer_1.reducer,{linkedProducts:[]}),productId=(0,core_data_1.useEntityId)("postType",postType),loadLinkedProductsDispatcher=(0,reducer_1.getLoadLinkedProductsDispatcher)(dispatch),selectSearchedProductDispatcher=(0,reducer_1.getSelectSearchedProductDispatcher)(dispatch),removeLinkedProductDispatcher=(0,reducer_1.getRemoveLinkedProductDispatcher)(dispatch),[linkedProductIds,setLinkedProductIds]=(0,use_product_entity_prop_1.default)(property,{postType});function searchProducts(search="",excludedIds=[]){return setSearchValue(search),setIsSearching(!0),getProductsBySearchValue(search,excludedIds).then((products=>{setSearchedProducts(products)})).finally((()=>{setIsSearching(!1)}))}(0,element_1.useEffect)((()=>{!state.selectedProduct&&linkedProductIds&&linkedProductIds.length>0&&loadLinkedProductsDispatcher(linkedProductIds)}),[linkedProductIds,state.selectedProduct]);const debouncedFilter=(0,compose_1.useDebounce)((function filter(search=""){searchProducts(search,[...linkedProductIds||[],productId])}),300);(0,element_1.useEffect)((()=>{isInSelectedTab&&!loadInitialSearchResults.current&&(loadInitialSearchResults.current=!0,searchProducts("",[...linkedProductIds||[],productId]))}),[isInSelectedTab,loadInitialSearchResults,linkedProductIds,productId]);const handleSelect=(0,element_1.useCallback)((product=>{if((linkedProductIds||[]).includes(product.id))return;const newLinkedProductIds=selectSearchedProductDispatcher(product,state.linkedProducts);setLinkedProductIds(newLinkedProductIds),searchProducts("",[...newLinkedProductIds||[],productId]),(0,tracks_1.recordEvent)("linked_products_product_add",{source:constants_1.TRACKS_SOURCE,field:property,product_id:productId,linked_product_id:product.id})}),[linkedProductIds,state.linkedProducts]);const[isChoosingProducts,setIsChoosingProducts]=(0,element_1.useState)(!1);return(0,element_1.createElement)("div",{...blockProps},(0,element_1.createElement)(block_slot_fill_1.SectionActions,null,(0,element_1.createElement)(components_1.Button,{variant:"tertiary",icon:icons_1.reusableBlock,onClick:async function chooseProductsForMe(){(0,tracks_1.recordEvent)("linked_products_choose_related_click",{source:constants_1.TRACKS_SOURCE,field:property}),dispatch({type:"LOADING_LINKED_PRODUCTS",payload:{isLoading:!0}}),setIsChoosingProducts(!0);const linkedProducts=await(0,get_related_products_1.getSuggestedProductsFor)({postId:productId,forceRequest:!0});if(dispatch({type:"LOADING_LINKED_PRODUCTS",payload:{isLoading:!1}}),setIsChoosingProducts(!1),!linkedProducts)return;const newLinkedProducts=selectSearchedProductDispatcher(linkedProducts,[]);setLinkedProductIds(newLinkedProducts)},isBusy:isChoosingProducts,disabled:isChoosingProducts},(0,i18n_1.__)("Choose products for me","woocommerce"))),(0,element_1.createElement)("div",{className:"wp-block-woocommerce-product-linked-list-field__form-group-content"},(0,element_1.createElement)(product_select_1.ProductSelect,{items:searchedProducts,filter:debouncedFilter,onSelect:handleSelect,isLoading:isSearching,selected:null})),state.isLoading&&(0,element_1.createElement)(product_list_1.Skeleton,null),!state.isLoading&&0===state.linkedProducts.length&&(0,element_1.createElement)(advice_card_1.AdviceCard,{tip:emptyState.tip,dismissPreferenceId:`woocommerce-product-${property}-advice-card-dismissed`,isDismissible:emptyState.isDismissible,onDismiss:function handleAdviceCardDismiss(){(0,tracks_1.recordEvent)("linked_products_placeholder_dismiss",{source:constants_1.TRACKS_SOURCE,field:property})}},(0,element_1.createElement)(EmptyStateImage,{...emptyState})),!state.isLoading&&state.linkedProducts.length>0&&(0,element_1.createElement)(product_list_1.ProductList,{products:state.linkedProducts,onRemove:function handleProductListRemove(product){const newLinkedProductIds=removeLinkedProductDispatcher(product,state.linkedProducts);setLinkedProductIds(newLinkedProductIds),searchProducts("",[...newLinkedProductIds||[],productId]),(0,tracks_1.recordEvent)("linked_products_product_remove",{source:constants_1.TRACKS_SOURCE,field:property,product_id:productId,linked_product_id:product.id})},onEdit:function handleProductListEdit(product){(0,tracks_1.recordEvent)("linked_products_product_select",{source:constants_1.TRACKS_SOURCE,field:property,product_id:productId,linked_product_id:product.id})},onPreview:function handleProductListPreview(product){(0,tracks_1.recordEvent)("linked_products_product_preview_click",{source:constants_1.TRACKS_SOURCE,field:property,product_id:productId,linked_product_id:product.id})}}))}exports.EmptyStateImage=EmptyStateImage,exports.LinkedProductListBlockEdit=LinkedProductListBlockEdit;