"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){void 0===k2&&(k2=k);var desc=Object.getOwnPropertyDescriptor(m,k);desc&&!("get"in desc?!m.__esModule:desc.writable||desc.configurable)||(desc={enumerable:!0,get:function(){return m[k]}}),Object.defineProperty(o,k2,desc)}:function(o,m,k,k2){void 0===k2&&(k2=k),o[k2]=m[k]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,"default",{enumerable:!0,value:v})}:function(o,v){o.default=v}),__importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(null!=mod)for(var k in mod)"default"!==k&&Object.prototype.hasOwnProperty.call(mod,k)&&__createBinding(result,mod,k);return __setModuleDefault(result,mod),result},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProductDetailsSectionDescriptionBlockEdit=void 0;const classnames_1=__importDefault(require("classnames")),components_1=require("@wordpress/components"),data_1=require("@wordpress/data"),element_1=require("@wordpress/element"),i18n_1=require("@wordpress/i18n"),icons=__importStar(require("@wordpress/icons")),block_templates_1=require("@woocommerce/block-templates"),navigation_1=require("@woocommerce/navigation"),tracks_1=require("@woocommerce/tracks"),core_data_1=require("@wordpress/core-data"),block_slot_fill_1=require("../../../components/block-slot-fill"),validation_context_1=require("../../../contexts/validation-context"),constants_1=require("../../../constants"),use_error_handler_1=require("../../../hooks/use-error-handler"),wooIcons=__importStar(require("../../../icons")),is_product_form_template_system_enabled_1=__importDefault(require("../../../utils/is-product-form-template-system-enabled")),format_product_error_1=require("../../../utils/format-product-error");function ProductDetailsSectionDescriptionBlockEdit({attributes,clientId,context:{selectedTab}}){var _a;const blockProps=(0,block_templates_1.useWooBlockProps)(attributes),{getProductErrorMessageAndProps}=(0,use_error_handler_1.useErrorHandler)(),{productTemplates,productTemplate:selectedProductTemplate}=(0,data_1.useSelect)((select=>{const{getEditorSettings}=select("core/editor");return getEditorSettings()})),[supportedProductTemplates,unsupportedProductTemplates]=productTemplates.reduce((([supported,unsupported],productTemplate)=>(productTemplate.isSelectableByUser&&(productTemplate.layoutTemplateId?supported.push(productTemplate):unsupported.push(productTemplate)),[supported,unsupported])),[[],[]]),productId=(0,core_data_1.useEntityId)("postType","product"),[productStatus]=(0,core_data_1.useEntityProp)("postType","product","status"),{validate}=(0,validation_context_1.useValidations)(),{editEntityRecord,saveEditedEntityRecord,saveEntityRecord}=(0,data_1.useDispatch)("core"),{createSuccessNotice,createErrorNotice}=(0,data_1.useDispatch)("core/notices"),rootClientId=(0,data_1.useSelect)((select=>{const{getBlockRootClientId}=select("core/block-editor");return getBlockRootClientId(clientId)}),[clientId]),[unsupportedProductTemplate,setUnsupportedProductTemplate]=(0,element_1.useState)(),productFormPosts=(0,data_1.useSelect)((sel=>(0,is_product_form_template_system_enabled_1.default)()&&sel("core").getEntityRecords("postType","product_form",{per_page:-1})||[]),[]),{isSaving}=(0,data_1.useSelect)((select=>{const{isSavingEntityRecord}=select("core");return{isSaving:isSavingEntityRecord("postType","product",productId)}}),[productId]);if(rootClientId)return(0,element_1.createElement)(block_slot_fill_1.BlockFill,{name:"section-description",slotContainerBlockName:"woocommerce/product-section"},(0,element_1.createElement)("div",{...blockProps},(0,element_1.createElement)("p",null,(0,element_1.createInterpolateElement)((0,i18n_1.__)("This is a <ProductTemplate />.","woocommerce"),{ProductTemplate:(0,element_1.createElement)("span",null,null===(_a=null==selectedProductTemplate?void 0:selectedProductTemplate.title)||void 0===_a?void 0:_a.toLowerCase())})),(0,element_1.createElement)(components_1.Dropdown,{focusOnMount:!0,popoverProps:{placement:"bottom-start"},renderToggle:({isOpen,onToggle})=>(0,element_1.createElement)(components_1.Button,{"aria-expanded":isOpen,variant:"link",onClick:toggleButtonClickHandler(isOpen,onToggle)},(0,element_1.createElement)("span",null,(0,i18n_1.__)("Change product type","woocommerce"))),renderContent:({onClose})=>(0,element_1.createElement)("div",{className:"wp-block-woocommerce-product-details-section-description__dropdown components-dropdown-menu__menu"},(0,element_1.createElement)(components_1.MenuGroup,null,supportedProductTemplates.map(getMenuItem(onClose))),(0,is_product_form_template_system_enabled_1.default)()&&(0,element_1.createElement)(components_1.MenuGroup,null,productFormPosts.map((formPost=>(0,element_1.createElement)(components_1.MenuItem,{key:formPost.id,icon:resolveIcon("external"),info:formPost.excerpt.raw,iconPosition:"left",onClick:onClose},formPost.title.rendered)))),unsupportedProductTemplates.length>0&&(0,element_1.createElement)(components_1.MenuGroup,null,(0,element_1.createElement)(components_1.Dropdown,{popoverProps:{placement:"right-start"},renderToggle:({isOpen,onToggle})=>(0,element_1.createElement)(components_1.MenuItem,{"aria-expanded":isOpen,icon:resolveIcon("chevronRight"),iconPosition:"right",onClick:onToggle},(0,element_1.createElement)("span",null,(0,i18n_1.__)("More","woocommerce"))),renderContent:()=>(0,element_1.createElement)("div",{className:"wp-block-woocommerce-product-details-section-description__dropdown components-dropdown-menu__menu"},(0,element_1.createElement)(components_1.MenuGroup,null,unsupportedProductTemplates.map(getMenuItem(onClose))))})))}),Boolean(unsupportedProductTemplate)&&(0,element_1.createElement)(components_1.Modal,{title:(0,i18n_1.__)("Change product type?","woocommerce"),className:"wp-block-woocommerce-product-details-section-description__modal",onRequestClose:()=>{setUnsupportedProductTemplate(void 0)}},(0,element_1.createElement)("p",null,(0,element_1.createElement)("b",null,(0,i18n_1.__)("This product type isn’t supported by the updated product editing experience yet.","woocommerce"))),(0,element_1.createElement)("p",null,(0,i18n_1.__)("You’ll be taken to the classic editing screen that isn’t optimized for commerce but offers advanced functionality and supports all extensions.","woocommerce")),(0,element_1.createElement)("div",{className:"wp-block-woocommerce-product-details-section-description__modal-actions"},(0,element_1.createElement)(components_1.Button,{variant:"secondary","aria-disabled":isSaving,onClick:()=>{isSaving||setUnsupportedProductTemplate(void 0)}},(0,i18n_1.__)("Cancel","woocommerce")),(0,element_1.createElement)(components_1.Button,{variant:"primary",isBusy:isSaving,"aria-disabled":isSaving,onClick:async function handleModalChangeClick(){var _a,_b;try{if(isSaving)return;const{id:productTemplateId,productData}=unsupportedProductTemplate;await validate(productData);const product=null!==(_a=await saveEditedEntityRecord("postType","product",productId,{throwOnError:!0}))&&void 0!==_a?_a:{id:productId},productMetaData=null!==(_b=null==productData?void 0:productData.meta_data)&&void 0!==_b?_b:[];await saveEntityRecord("postType","product",{...product,...productData,meta_data:[...productMetaData,{key:"_product_template_id",value:productTemplateId}]},{throwOnError:!0}),createSuccessNotice((0,i18n_1.__)("Product type changed.","woocommerce")),(0,tracks_1.recordEvent)("product_template_changed",{source:constants_1.TRACKS_SOURCE,template:productTemplateId}),window.location.href=(0,navigation_1.getNewPath)({},`/product/${productId}`)}catch(error){const{message,errorProps}=await getProductErrorMessageAndProps((0,format_product_error_1.formatProductError)(error,productStatus),selectedTab);createErrorNotice(message,errorProps)}}},(0,i18n_1.__)("Change","woocommerce"))))));function menuItemClickHandler(productTemplate,onClose){return async function handleMenuItemClick(){var _a;try{if((0,tracks_1.recordEvent)("product_template_selector_selected",{source:constants_1.TRACKS_SOURCE,selected_template:productTemplate.id,unsupported_template:!productTemplate.layoutTemplateId}),!productTemplate.layoutTemplateId)return setUnsupportedProductTemplate(productTemplate),void onClose();await validate(productTemplate.productData);const productMetaData=null!==(_a=productTemplate.productData.meta_data)&&void 0!==_a?_a:[];await editEntityRecord("postType","product",productId,{...productTemplate.productData,meta_data:[...productMetaData,{key:"_product_template_id",value:productTemplate.id}]}),await saveEditedEntityRecord("postType","product",productId,{throwOnError:!0}),createSuccessNotice((0,i18n_1.__)("Product type changed.","woocommerce")),(0,tracks_1.recordEvent)("product_template_changed",{source:constants_1.TRACKS_SOURCE,template:productTemplate.id})}catch(error){const{message,errorProps}=await getProductErrorMessageAndProps((0,format_product_error_1.formatProductError)(error,productStatus),selectedTab);createErrorNotice(message,errorProps)}onClose()}}function resolveIcon(iconId,alt){if(!iconId)return;const{Icon}=icons;let icon;if(/^https?:\/\//.test(iconId))icon=(0,element_1.createElement)("img",{src:iconId,alt});else{if(!(iconId in icons)&&!(iconId in wooIcons))return;icon=icons[iconId]||wooIcons[iconId]}return(0,element_1.createElement)(Icon,{icon,size:24})}function getMenuItem(onClose){return function renderMenuItem(productTemplate){var _a;const isSelected=(null==selectedProductTemplate?void 0:selectedProductTemplate.id)===productTemplate.id;return(0,element_1.createElement)(components_1.MenuItem,{key:productTemplate.id,info:null!==(_a=productTemplate.description)&&void 0!==_a?_a:void 0,isSelected,icon:isSelected?resolveIcon("check"):resolveIcon(productTemplate.icon,productTemplate.title),iconPosition:"left",role:"menuitemradio",onClick:menuItemClickHandler(productTemplate,onClose),className:(0,classnames_1.default)({"components-menu-item__button--selected":isSelected})},productTemplate.title)}}function toggleButtonClickHandler(isOpen,onToggle){return function onClick(){onToggle(),isOpen||(0,tracks_1.recordEvent)("product_template_selector_open",{source:constants_1.TRACKS_SOURCE,supported_templates:supportedProductTemplates.map((productTemplate=>productTemplate.id)),unsupported_template:unsupportedProductTemplates.map((productTemplate=>productTemplate.id))})}}}exports.ProductDetailsSectionDescriptionBlockEdit=ProductDetailsSectionDescriptionBlockEdit;