"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImageBlockEdit=void 0;const i18n_1=require("@wordpress/i18n"),components_1=require("@wordpress/components"),data_1=require("@wordpress/data"),classnames_1=__importDefault(require("classnames")),element_1=require("@wordpress/element"),icons_1=require("@wordpress/icons"),block_templates_1=require("@woocommerce/block-templates"),components_2=require("@woocommerce/components"),tracks_1=require("@woocommerce/tracks"),core_data_1=require("@wordpress/core-data"),place_holder_1=require("./place-holder"),block_slot_fill_1=require("../../../components/block-slot-fill"),map_upload_image_to_image_1=require("../../../utils/map-upload-image-to-image");function ImageBlockEdit({attributes,context}){var _a,_b;const{property,multiple}=attributes,[propertyValue,setPropertyValue]=(0,core_data_1.useEntityProp)("postType",context.postType,property),[isRemovingZoneVisible,setIsRemovingZoneVisible]=(0,element_1.useState)(!1),[isRemoving,setIsRemoving]=(0,element_1.useState)(!1),[draggedImageId,setDraggedImageId]=(0,element_1.useState)(null),blockProps=(0,block_templates_1.useWooBlockProps)(attributes,{className:(0,classnames_1.default)({"has-images":Array.isArray(propertyValue)?propertyValue.length>0:Boolean(propertyValue)})}),{createErrorNotice}=(0,data_1.useDispatch)("core/notices");function uploadHandler(eventName){return function handleFileUpload(upload){var _a;if((0,tracks_1.recordEvent)(eventName),Array.isArray(upload)){const images=upload.filter((image=>image.id)).map((image=>({id:image.id,name:image.title,src:image.url,alt:image.alt})));(null===(_a=upload[0])||void 0===_a?void 0:_a.id)&&setPropertyValue([...propertyValue,...images])}else upload.id&&setPropertyValue((0,map_upload_image_to_image_1.mapUploadImageToImage)(upload))}}const isImageGalleryVisible=null!==propertyValue&&(!Array.isArray(propertyValue)||propertyValue.length>0);return(0,element_1.createElement)("div",{...blockProps},(0,element_1.createElement)("div",{className:"woocommerce-product-form__image-drop-zone"},isRemovingZoneVisible?(0,element_1.createElement)("div",{className:"woocommerce-product-form__remove-image-drop-zone"},(0,element_1.createElement)("span",null,(0,element_1.createElement)(icons_1.Icon,{icon:icons_1.trash,size:20,className:"icon-control"}),(0,i18n_1.__)("Drop here to remove","woocommerce")),(0,element_1.createElement)(components_1.DropZone,{onHTMLDrop:()=>setIsRemoving(!0),onDrop:()=>setIsRemoving(!0),label:(0,i18n_1.__)("Drop here to remove","woocommerce")})):(0,element_1.createElement)(block_slot_fill_1.SectionActions,null,(0,element_1.createElement)("div",{className:"woocommerce-product-form__media-uploader"},(0,element_1.createElement)(components_2.MediaUploader,{value:Array.isArray(propertyValue)?propertyValue.map((({id})=>id)):null!==(_a=null==propertyValue?void 0:propertyValue.id)&&void 0!==_a?_a:void 0,multipleSelect:!!multiple&&"add",maxUploadFileSize:null===(_b=window.productBlockEditorSettings)||void 0===_b?void 0:_b.maxUploadFileSize,onError:function(error){createErrorNotice((0,i18n_1.sprintf)((0,i18n_1.__)("Error uploading image:%1$s%2$s","woocommerce"),"\n",error.message))},onFileUploadChange:uploadHandler("product_images_add_via_file_upload_area"),onMediaGalleryOpen:()=>{(0,tracks_1.recordEvent)("product_images_media_gallery_open")},onSelect:function handleSelect(selection){if((0,tracks_1.recordEvent)("product_images_add_via_media_library"),Array.isArray(selection)){const images=selection.map(map_upload_image_to_image_1.mapUploadImageToImage).filter((image=>null!==image));setPropertyValue(images)}else setPropertyValue((0,map_upload_image_to_image_1.mapUploadImageToImage)(selection))},onUpload:uploadHandler("product_images_add_via_drag_and_drop_upload"),label:"",buttonText:(0,i18n_1.__)("Choose an image","woocommerce")})))),isImageGalleryVisible?(0,element_1.createElement)(components_2.ImageGallery,{allowDragging:!1,onDragStart:function handleDragStart(event){var _a,_b;if(Array.isArray(propertyValue)){const{id:imageId,dataset}=event.target;if(imageId)setDraggedImageId(parseInt(imageId,10));else if(null==dataset?void 0:dataset.index){const index=parseInt(dataset.index,10);setDraggedImageId(null!==(_b=null===(_a=propertyValue[index])||void 0===_a?void 0:_a.id)&&void 0!==_b?_b:null)}setIsRemovingZoneVisible((current=>!current))}},onDragEnd:function handleDragEnd(){Array.isArray(propertyValue)&&(isRemoving&&draggedImageId&&((0,tracks_1.recordEvent)("product_images_remove_image_button_click"),setPropertyValue(propertyValue.filter((img=>img.id!==draggedImageId))),setIsRemoving(!1),setDraggedImageId(null)),setIsRemovingZoneVisible((current=>!current)))},onOrderChange:function orderImages(newOrder){if(Array.isArray(propertyValue)){const memoIds=propertyValue.reduce(((current,item)=>({...current,[`${item.id}`]:item})),{}),orderedImages=newOrder.filter((image=>{var _a;return(null===(_a=null==image?void 0:image.props)||void 0===_a?void 0:_a.id)in memoIds})).map((image=>{var _a;return memoIds[null===(_a=null==image?void 0:image.props)||void 0===_a?void 0:_a.id]}));(0,tracks_1.recordEvent)("product_images_change_image_order_via_image_gallery"),setPropertyValue(orderedImages)}},onReplace:function handleReplace({replaceIndex,media}){if((0,tracks_1.recordEvent)("product_images_replace_image_button_click"),Array.isArray(propertyValue)){if(propertyValue.some((img=>media.id===img.id)))return;const image=(0,map_upload_image_to_image_1.mapUploadImageToImage)(media);if(image){const newImages=[...propertyValue];newImages[replaceIndex]=image,setPropertyValue(newImages)}}else setPropertyValue((0,map_upload_image_to_image_1.mapUploadImageToImage)(media))},onRemove:function handleRemove({removedItem}){if((0,tracks_1.recordEvent)("product_images_remove_image_button_click"),Array.isArray(propertyValue)){const remainingImages=propertyValue.filter((image=>String(image.id)!==removedItem.props.id));setPropertyValue(remainingImages)}else setPropertyValue(null)},onSelectAsCover:()=>(0,tracks_1.recordEvent)("product_images_select_image_as_cover_button_click")},(Array.isArray(propertyValue)?propertyValue:[propertyValue]).map(((image,index)=>(0,element_1.createElement)(components_2.ImageGalleryItem,{key:image.id,alt:image.alt,src:image.src,id:`${image.id}`,isCover:multiple&&0===index})))):(0,element_1.createElement)(place_holder_1.PlaceHolder,{multiple}))}exports.ImageBlockEdit=ImageBlockEdit;