"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Edit=void 0;const i18n_1=require("@wordpress/i18n"),data_1=require("@woocommerce/data"),block_templates_1=require("@woocommerce/block-templates"),tracks_1=require("@woocommerce/tracks"),element_1=require("@wordpress/element"),data_2=require("@wordpress/data"),core_data_1=require("@wordpress/core-data"),variations_table_1=require("../../../components/variations-table"),validation_context_1=require("../../../contexts/validation-context"),use_product_entity_prop_1=__importDefault(require("../../../hooks/use-product-entity-prop")),variable_product_tour_1=require("./variable-product-tour"),constants_1=require("../../../constants"),handle_prompt_1=require("../../../utils/handle-prompt"),empty_state_1=require("../../../components/empty-state");function Edit({attributes,context:{isInSelectedTab}}){const noticeDismissed=(0,element_1.useRef)(!1),{invalidateResolution}=(0,data_2.useDispatch)(data_1.EXPERIMENTAL_PRODUCT_VARIATIONS_STORE_NAME),productId=(0,core_data_1.useEntityId)("postType","product"),blockProps=(0,block_templates_1.useWooBlockProps)(attributes),[productStatus]=(0,core_data_1.useEntityProp)("postType","product","status"),[productHasOptions]=(0,core_data_1.useEntityProp)("postType","product","has_options"),[productAttributes]=(0,use_product_entity_prop_1.default)("attributes"),hasVariationOptions=(0,element_1.useMemo)((function hasAttributesUsedForVariations(){return null==productAttributes?void 0:productAttributes.some((productAttribute=>productAttribute.variation))}),[productAttributes]),totalCountWithoutPriceRequestParams=(0,element_1.useMemo)((()=>({product_id:productId,order:"asc",orderby:"menu_order",has_price:!1})),[productId]),{totalCountWithoutPrice}=(0,data_2.useSelect)((select=>{const{getProductVariationsTotalCount}=select(data_1.EXPERIMENTAL_PRODUCT_VARIATIONS_STORE_NAME);return{totalCountWithoutPrice:productHasOptions?getProductVariationsTotalCount(totalCountWithoutPriceRequestParams):0}}),[productHasOptions,totalCountWithoutPriceRequestParams]),{updateUserPreferences,variable_items_without_price_notice_dismissed:itemsWithoutPriceNoticeDismissed}=(0,data_1.useUserPreferences)(),{ref:variationTableRef}=(0,validation_context_1.useValidation)("variations",(async function regularPriceValidator(defaultValue,newData){if(totalCountWithoutPrice>0&&!noticeDismissed.current&&"publish"!==productStatus&&"publish"===(null==newData?void 0:newData.status))return"yes"!==itemsWithoutPriceNoticeDismissed&&updateUserPreferences({variable_items_without_price_notice_dismissed:{...itemsWithoutPriceNoticeDismissed||{},[productId]:"no"}}),{message:(0,i18n_1.__)("Set variation prices before adding this product.","woocommerce")}}),[totalCountWithoutPrice]);const hasNotDismissedNotice=!itemsWithoutPriceNoticeDismissed||"yes"!==itemsWithoutPriceNoticeDismissed[productId],noticeText=totalCountWithoutPrice>0&&hasNotDismissedNotice?(0,i18n_1.sprintf)((0,i18n_1.__)("%d variations do not have prices. Variations that do not have prices will not be visible to customers.","woocommerce"),totalCountWithoutPrice):"";return hasVariationOptions?(0,element_1.createElement)("div",{...blockProps},(0,element_1.createElement)(variations_table_1.VariationsTable,{isVisible:isInSelectedTab,ref:variationTableRef,noticeText,onNoticeDismiss:()=>{noticeDismissed.current=!0,updateUserPreferences({variable_items_without_price_notice_dismissed:{...itemsWithoutPriceNoticeDismissed||{},[productId]:"yes"}})},noticeActions:[{label:(0,i18n_1.__)("Set prices","woocommerce"),onClick:function onSetPrices(handleUpdateAll){(0,tracks_1.recordEvent)("product_variations_set_prices_select",{source:constants_1.TRACKS_SOURCE});const productVariationsListPromise=(0,data_2.resolveSelect)(data_1.EXPERIMENTAL_PRODUCT_VARIATIONS_STORE_NAME).getProductVariations({product_id:productId,order:"asc",orderby:"menu_order",has_price:!1,_fields:["id"],per_page:totalCountWithoutPrice});(0,handle_prompt_1.handlePrompt)({onOk(value){(0,tracks_1.recordEvent)("product_variations_set_prices_update",{source:constants_1.TRACKS_SOURCE}),productVariationsListPromise.then((variations=>{handleUpdateAll(variations.map((({id})=>({id,regular_price:value}))))}))}})},className:"is-destructive"}],onVariationTableChange:(type,update)=>{("delete"===type||"update"===type&&update&&update.find((variation=>"regular_price"in variation||"sale_price"in variation)))&&invalidateResolution("getProductVariationsTotalCount",[totalCountWithoutPriceRequestParams])}}),isInSelectedTab&&(0,element_1.createElement)(variable_product_tour_1.VariableProductTour,null)):(0,element_1.createElement)(empty_state_1.EmptyState,{names:[(0,i18n_1.__)("Variation","woocommerce"),(0,i18n_1.__)("Colors","woocommerce"),(0,i18n_1.__)("Sizes","woocommerce")]})}exports.Edit=Edit;